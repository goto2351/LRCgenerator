<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">

        <title>LRCgenerator</title>

        <style>
            html{
                font-family:sans-serif;
            }

            body{
                width: 50%;
                max-width: 800px;
                min-width: 400px;
                margin: 0 auto;
            }

            input[type=range]{
                height: 24px;
                width: 500px;
            }

            input[type=button]{
                height: 24px;
            }

            input[type=text]{
                width: 450px;
            }

            table{
                border-collapse: collapse;
            }

            table th, table td{
                border: solid 1px black;
            }

        </style>
    </head>

    <body>
        <br>
        <input type="file" id="targetFile" size=50 oninput=loadMusic()><br>

        <input type="button" id="playButton" value="▶" onclick=playButton_click()> 
        <input type="range" id="timebar" value="0" min="0" max="100" step="0.01" oninput=setTime()><br>

        Time:
        <output id="timeLabel"></output>
        <input type="button" value="クリップボードに書き出し" id="outputButton" onclick=exportLyric()><br>

        <label for="lyric">歌詞: </label>
        <input type="text" id="lyric">
        <input type="button" id="addButton" value="追加" onclick=addLyric()><br>
        <br>

        <table border="1" id="lyricTable" width=650px>
            <tr>
                <th width=100px>Time</th>
                <th>歌詞</th>
                <th width=70px>削除</th>
            </tr>
        </table>

        <script>
            //todo: script部分を別ファイルに分けてすっきりさせたい
            //todo: cssをもうちょっと綺麗にしたい
            var isPlaying = false;//再生状態

            var file;
            var reader = new FileReader();
            var music = new Audio();

            var lyric_array = [];//時刻と歌詞の格納

            music.volume = 0.3;
            //現在時刻を表示
            music.addEventListener('timeupdate', function(){
                document.getElementById('timeLabel').value = music.currentTime.toFixed(2);
                document.getElementById('timebar').value = (music.currentTime / music.duration) * 100;
            })

            //ファイルの読み込み
            function loadMusic(){
                file = document.getElementById('targetFile').files[0];
                reader.onload = function(evt){
                    music.src = reader.result;
                }
                reader.readAsDataURL(file);
            }

            //再生/一時停止ボタンの処理を再生状態によって切り替える
            function playButton_click(){
                if(isPlaying === true){
                    //再生中の時は一時停止
                    pauseMusic();
                    document.getElementById('playButton').value = "▶";
                }else{
                    playMusic();
                    document.getElementById('playButton').value = "||";
                }
            }
            //再生ボタンの処理
            function playMusic(){
                music.play();
                isPlaying = true;
            }

            //一時停止ボタン
            function pauseMusic(){
                music.pause();
                isPlaying = false;
            }

            //シークバーの値が変わったときの時刻変更
            function setTime(){
                var v = document.getElementById('timebar').value;
                var newTime;
                newTime = (v/100) * music.duration;
                music.currentTime = newTime;
            }

            //Enterキーで歌詞を追加する
            document.getElementById('lyric').addEventListener('keypress', onKeyPress);
            function onKeyPress(e){
                if(e.keyCode === 13){
                    addLyric();
                }
            }

            //歌詞の追加
            function addLyric(){
                var newline = [music.currentTime, document.getElementById('lyric').value];
                lyric_array.push(newline);
                //時刻順にソート
                lyric_array.sort(function(a,b){return(a[0] - b[0]);});
                updateTable();
                //歌詞の入力欄を空にする
                document.getElementById('lyric').value = "";
            }

            //表で指定された歌詞の削除
            function deleteLyric(obj){
                //削除ボタンの押された行を取得
                var line = obj.parentNode.parentNode;
                var index = line.sectionRowIndex - 1

                //歌詞データの当該行をnullにする
                lyric_array[index][0] = null;
                lyric_array[index][1] = null;
                //nullにした行をトップにして削除
                lyric_array.sort(function(a,b){return(a[0] - b[0]);});
                lyric_array.shift();

                //新しい配列に基づいて表を更新する
                updateTable();
            }

            //表の書き換え
            function updateTable(){
                var table = document.getElementById('lyricTable');

                //見出し以外全ての行を削除する
                while(table.rows.length > 1) table.deleteRow(1);

                //配列に沿って行を追加していく
                for(var i = 0; i < lyric_array.length; i++){
                    //末尾に行を追加
                    var row = table.insertRow(-1);
                    //セルを追加
                    var cell_time = row.insertCell(-1);
                    var cell_lyric = row.insertCell(-1);
                    var cell_delete = row.insertCell(-1);
                    //セルに内容を書き込む
                    //todo:表から直接要素訂正の機能→ここでidを指定すればできる？
                    cell_time.innerHTML = lyric_array[i][0];
                    cell_lyric.innerHTML = lyric_array[i][1];
                    cell_delete.innerHTML = '<input type="button" value="削除" id="deleteButton" onclick=deleteLyric(this)>'
                }
            }

            //lrcファイル用テキストを生成してコピーする
            function exportLyric(){
                var lrcText = "";
                for(var i = 0; i < lyric_array.length; i++){
                    var lrc_time;
                    var lrc_lyric;

                    //時刻をlrcの形式に変換する
                    var m = Math.floor(lyric_array[i][0] / 60);//分
                    var s1 = Math.floor(lyric_array[i][0] - m * 60);//秒
                    var s2 = Math.floor((lyric_array[i][0] - (m * 60 + s1)).toFixed(2) * 100);

                    //文字列型に変換
                    var m_str = ('00' + m.toString()).slice(-2);
                    var s1_str = ('00' + s1.toString()).slice(-2);
                    var s2_str = ('00' + s2.toString()).slice(-2);

                    //時刻部分を生成
                    lrc_time = "[" + m_str + ":" + s1_str + ":" + s2_str + "]";
                    //歌詞部分
                    lrc_lyric = lyric_array[i][1];

                    //テキストに行を追加
                    lrcText += lrc_time + lrc_lyric + '\n';
                }
                //クリップボードにコピーする
                if(navigator.clipboard){
                    navigator.clipboard.writeText(lrcText);
                }
            }
        </script>
    </body>
</html>